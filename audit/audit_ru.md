# Аудит смарт контрактов TKP.

Статус - в работе, последняя редакция 2018-04-06

## Общие замечания

Код контрактов проверен на предмет программных закладок и критических ошибок спобоных привести к потере денег инвесторами.
  
* Присутствует возможность пересылки/использования токенов до периода окончания ICO.
* Наличие управляющего контракта Controller не исключает возможность проведения этапов без использования данного контракта.

Токен TKP наследует функционал контрактов ERC20Basic, ERC20, BasicToken, StandardToken, MintableToken, а так же Ownable - реализующего механизм владения контрактом и позволяющего устновить агента, которому разрешено выпускать токены.

Предпродажа токенов TKP осуществляется через контракт preICO, наследующего функционал FinalizableCrowdsale, и функционал контрактов Ownable - реализующего механизм владения контрактом и Pausable - позволяющиго поставить распродажу на паузу.

Распродажа токенов TKP осуществляется через контракт ICO, наследующего контракты Ownable - реализующего механизм владения контрактом и Pausable - позволяющиго поставить распродажу на паузу.

Финализация ICO осуществляется с помощью контракта postICO, в котором производится дополнительная эмиссия токенов, контракт наследует Ownable - реализующего механизм владения контрактом.

Управление текущим этапом ICO осуществляет контракт Controller.

Некоторые контракты используют методы библиотеки MathLib для безопасных вычислений.

Не зафиксирована версия компилятора, устновка pragma solidity допускает более новые версии компилятора, однако уже сейчас компиляция в них вызывает множественные warning сообщения.
Рекомендация: устновить pragma solidity 0.4.20;  (без ^)

## Обзор контрактов

MathLib

1) (Не критично) Использование оператора require вместо assert позволит сэкономить газ в случае ошибочных вычислений в методах контракта.

ERC20Basic

1) (Примечание) Упрощенная веерсия интерфейса ERC20

ERC20

1) (Примечание) ERC20 интерфейс

ShortAddressProtection

1) (Не критично) Использование оператора require вместо assert позволит сэкономить газ в случае ошибочных вычислений в методах контракта.

BasicToken

1) (Важно) Контракты ICO и preICO, использующие данный токен, наследуют модификаторы контраткта Pausable, которые запрещают покупку токенов во время паузы, однако функция transfer это не учитывает, что может позволить участникам использовать/пересылать уже имеющиеся токены во время остановленного этапа preICO или ICO.   

StandardToken

1) (Важно) функция transferFrom не учитывает паузу в контрактах ICO и preICO (см. замечание к BasicToken)   

Ownable

1) (Примечание) Владелец контракта может назначить другого владельца.

MintableToken

1) (Важно) Выпуск токенов может производиться только с адреса агента
2) (Важно) Только владелец может установить адрес агента, необходимо использовать контракт Controller для управления этапами ICO, чтобы исключить возможность установки произвольного адреса агента до вызова завершающей функии в postICO    

Token

1) (примечание) Задаются публичные параметры токена

Pausable

1) Наследует Ownable
2) (Примечание) Контракт содержит функционал, позволяющий его владельцу переключать триггер paused во включеное и выключеное положение, и модификаторы позволяющие вызов некоторых функций только в режиме паузы или только в режиме вне паузы.

FinalizableCrowdsale

1) Наследует Pausable
2) (Примечание) Только владелец может может завершить краудсейл

RefundVault

1) (Примечание) контракт хранит все средства на время краудсейла, владельцем vault является контракт preICO

preICO

1) Наследует FinalizableCrowdsale, владелец может сменить владельца и ставить на паузу
2) (Примечание) жестко прописано ограничение на минимальное количество покупаемых токенов - 100
3) (Важно) токены можно пересылать/использовать вне контракта preICO во время паузы (см. замечание к BasicToken)
4) (Средне) для корректной работы, надо использовать контракт Controller для автоматизации переключения между этапами владелец или же владелец токена должен установить его адрес в качестве saleAgent 
5) (Средне) В случае если preICO несостоится (не закроется softCap), предусмотрен возврат средств инвесторам, но не предусмотрен возврат/сжигание токенов, в случае если, например, планируются повторные попытки ICO.

ICO

1) Наследует Pausable, владелец может сменить владельца и ставить на паузу
2) (Примечание) жестко прописано ограничение на минимальное количество покупаемых токенов - 100
3) (Важно) токены можно пересылать/использовать вне контракта preICO во время паузы (см. замечание к BasicToken и preICO)
4) (Важно) нет ограничений по отправке/использованию токенов в периоды проведения ICO.
5) (Не критично) рассчитанные периоды повышения цены токена смещены на 2 минуты от старта ICO, т.е. фактически действуют от 0:01:00 в день старта и далее в кажом периоде до 23:59 6-го дня, соответственно начало периода не в 0:00:00 первого дня очередного периода, а в 23:59:00 последнего дня предыдущего периода 
4) (Средне) для корректной работы, надо использовать контракт Controller для автоматизации переключения между этапами владелец или же владелец токена должен установить его адрес в качестве saleAgent 
7) (Примечание) При деплое контракта надо точно задать даты начала и конца ICO, чтобы не пересеклись в preICO
8) (Не критично) определен mapping(address => uint256) public deposited; - но не используется

postICO

1) Наследует Ownable, владелец может сменить владельца
2) (Примечание) При деплое контракта надо точно задать дату конца ICO, чтобы не пересеклась c ICO
3) (Средне) для корректной работы, надо использовать контракт Controller для автоматизации переключения между этапами владелец или же владелец токена должен установить его адрес в качестве saleAgent 
4) (Не критично) функции claim имеют неоптимальный код и в некоторых случаях незначительный перерасход газа 

Controller

1) Наследует Ownable, владелец может сменить владельца
2) (Средне) После деплоя контракта, для корректной работы, владелец должен установить его адрес в качестве нового владельца токена
3) (Средне) При деплое контракта, указываются вдреса всех остальных контрактов этапов ICO, т.е. они должны уже быть задеплоены в сеть.
4) (Не критично) проверка require(token.owner() == address(this)); в функциях startICO и startPostICO избыточна, т.к. нет условий при которых это проверка может не выполнится 
5) (Важно) Наличие этого контракта никак не мешает владельцу его вообще не использовать для проведения этапов ICO, т.к. у инвесторов нет возможности проверить, что управление этапами ICO осуществляется именно через этот контракт.

* Рекомендация (вариант 1) - акцентировать внимание инвесторов на факте наличия данного контракта, как едиственно верного источника о контрактах этапов ICO.   
* Рекомендация (вариант 2) - осуществлять деплой контрактов каждого из этапов ICO непосредственной из соответствующей функции контракта Controller, в таком случае будет частично исключена ручная передача параметров и контракты каждого из этапов будут просто отсутствовать в сети до начала этих этапов.
 

Контракт Migrations не связан с остальными контрактами.

## Предупреждение об ответственности

Этот аудит касается только исходных кодов смарт контрактов и не должен рассматриваться как одобрение платформы, команды или компании.

## Авторы

Аудит провёл Михаил Семёнкин ([Mikhail Semenkin](https://t.me/krogla)), команда [EthereumWorks](https://github.com/EthereumWorks)
По вопросам проведения аудитов и разработки смарт контрактов обращайтесь: Telegram - @SlavaPoe, Skype - v.poskonin (MousePo).